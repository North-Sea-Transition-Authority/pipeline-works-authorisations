# Pipeline Works Authorisations

## Project setup

### Prerequisites
#### Downloads/Installation
* IntelliJ Ultimate
* Git Bash
* Java v11 - ([Recommended Library - Adoptium](https://adoptium.net/temurin/releases))
* Python v2.7 - ([Official Download](https://www.python.org/downloads/release/python-278/))
* Node LTS + NPM v12 - ([Official Download](https://nodejs.org/download/release/v12.22.12/))

#### Permissions / Project Access
* TPM - PWA Project Access - ([Location](https://tpm.fivium.local/index.php/prj/view/95))

### Steps

#### Initialise the Fivium Design System
* In Git Bash, from Project Home Directory
* `git submodule update --init --recursive`    
* `cd fivium-design-system-core && npm install && npx gulp build && cd ..`

#### Build frontend components
* `npm install`
* `npx gulp buildAll`

#### Configure the following environment variables


| Environment Variable | Description                                                                                       |
| -------------------- |---------------------------------------------------------------------------------------------------|
| CONTEXT_SUFFIX | A unique per developer suffix string to apply to the application context path. E.g. your initials |
| DB_SCHEMA_NAME | Database schema to connect as. E.g. `PWA_XX` Where XX is recommended to be your CONTEXT_SUFFIX    |
| PWA_GOVUK_NOTIFY_API_KEY | The API Key for GOV.UK Notify. (TPM Item: `GOV.UK Notify local-dev API key` for local dev)        |
| PWA_TEST_EMAIL_RECIPIENT | Set this on dev/test environments to receive all emails generated by the application              |
| PWA_TEST_EMAIL_RECIPIENT | Email address(es) CSV to send test emails to (use your own email address for local dev)           |
| PWA_GOVUK_PAY_API_KEY | The Test GOV.UK Pay Api key for OGA apps. (TPM Item: `PWA GovPay (Stripe) Dev + ST` for local dev)  |

#### Create the Flyway user

This must be your DB_SCHEMA_NAME with '_flyway' appended to the end.

```oraclesqlplus
CREATE USER pwa_xx_flyway IDENTIFIED BY "dev1"
/

GRANT UNLIMITED TABLESPACE TO pwa_xx_flyway WITH ADMIN OPTION
/

GRANT
  CREATE SESSION, 
  CREATE USER,
  DROP ANY TABLE,
  CREATE ANY TABLE,
  CREATE TABLE, -- Not covered by above grant. They are different.
  CREATE ANY VIEW,
  CREATE ANY INDEX, 
  SELECT ANY TABLE,
  DELETE ANY TABLE,
  LOCK ANY TABLE,
  INSERT ANY TABLE, 
  UPDATE ANY TABLE,
  ALTER ANY TABLE,
  DROP ANY INDEX,
  CREATE ANY SEQUENCE,
  SELECT ANY SEQUENCE,
  DROP ANY SEQUENCE,
  CREATE ANY PROCEDURE,
  GRANT ANY OBJECT PRIVILEGE,
  DROP ANY VIEW
TO pwa_xx_flyway WITH ADMIN OPTION
/
GRANT EXECUTE ON decmgr.contact TO pwa_xx_flyway
/
```
This user must be created before the app runs for the first time on a new DB. All migrations will be run by this flyway user.

#### Set the active profile
Set the profile to `development` in your run configuration

#### Setup Checkstyle
* Install the Checkstyle-IDEA plugin (from third-party repositories)
* Go to Settings > Checkstyle
* Set Checkstyle Version - `8.40`
* Add a "Configuration File"
* "Use a local Checkstyle file"
* Select `ide/checkstyle.xml`
* Check box for "Store relative to project location"
* Leave Checkstyle-Suppression blank
* Check the "Active" box next to the new profile
* On the Git commit dialog tick the 'Scan with Checkstyle' box in the 'Before Commit' section
  
  Note that Checkstyle rules are checked during the build process and any broken rules will fail the build.
    
#### Proxy routes to enable session sharing

To enable Spring to access the fox session, you must access your local instance under the same hostname and application context (itportal.dev.decc.local/engedudev1/).

##### Add Proxy Pass to Apache Server
The easiest way to do this is to add a ProxyPass rule to Apache running on itportal.dev.decc.local. \
Checkout Project - `fivium-dev-app` [here](https://bitbucket.org/fiviumuk/fivium-dev-app/src/master/) 
```
location /engedudev1/XX/ {
  proxy_pass  http://ZZ.fivium.local:8081/engedudev1/XX/;
}
```
 
Edit the `nginx.conf` configuration file at src/master/app/volumes/ops/nginx_oga/nginx.conf and add a ProxyPass rule.
* Where XX is your CONTEXT_SUFFIX and.
* Where ZZ is your NUC / Local Device name.

This will setup the fox server to forward traffic labeled under your CONTEXT_SUFFIX to be served by your local machine.

##### Update to new config file version
Once you have added the ProxyPass rule you will need to increment the version number of the nginx configuration file.\
Edit the `ops.yml` Yaml file at src/master/app/compose/ops.yml and increment the oga niginx config version. \
For example if the following was included in the `ops.yml` file

`source: nginx_nginx.conf1`

This will need to be updated to

`source: nginx_nginx.conf2`

There are two references to the nginx config version within this file so ensure you update both. \
Commit and push the changes to both files and once the build has passed the ProxyPass rule will be ready to use.


#### Run the app
IntelliJ should auto detect the Spring application and create a run configuration.\
Run the project and wait for terminal output similar to the below example:
```
Started PipelineWorksAuthorisationApplication in 26.086 seconds (JVM running for 26.832)
```

To Check your system is up and responding, navigate to https://itportal.dev.fivium.local/engedudev1/XX/actuator/health \
Where XX is your CONTENT_SUFFIX, you should be presented with `Status:UP` \
From there you can login in via the Energy Portal and access the PWA from the sidebar. \
https://itportal.dev.fivium.local/engedudev1/fox/nsta/NSTA_LOGIN/login

**NOTE**: The energy portal will navigate you to the distributed DEV instance by default, \
`https://itportal.dev.fivium.local/engedudev1/pwa/work-area` \
to use your own version change /pwa/ to your CONTENT_SUFFIX.

### GOV.UK Notify setup
To add new or modify email templates you will need to be invited to the GOV.UK notification service (https://www.notifications.service.gov.uk/) by a member of the team who already has access.

## Documentation

The [Architectural Decision Records](https://adr.github.io/) pattern should be used to document important technical decisions and the reasoning behind them. This project uses the [MADR](https://adr.github.io/madr/) format. Records can be found in the `docs/adr` folder. 

## Troubleshooting / Known Issues
* Flyway Migration Fails on fresh deployment of project:
  * Legacy PWA tables may have been removed from distributed database
  * Run the following SQL script to reinstate the nessercary tables:
  ```
  CREATE TABLE decmgr.pipeline_authorisations (
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY
  );

  CREATE TABLE decmgr.xview_pipeline_auth_details (
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY
    ,pa_id NUMBER NOT NULL
  );

  CREATE TABLE decmgr.xview_pipeline_company_hist (
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY
  );

  CREATE TABLE decmgr.xview_pipelines_history (
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY
  );

  CREATE TABLE decmgr.xview_pipeline_app_details (
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY
    ,status_control VARCHAR(1)
  );
  
  CREATE TABLE decmgr.pipeline_authorisation_details (
    id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY
  );
  ```
  * Flyway Script 180 Failure - Set to Success 
  * Version Null File: 0000 - Set to Success