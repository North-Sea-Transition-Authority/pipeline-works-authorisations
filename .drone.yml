kind: pipeline
type: docker
name: default

steps:
  - name: fetch-fds-submodule
    image: alpine/git
    commands:
      # Drone cannot auth to a ssh based repo, so override to https to make use of .netrc
      - git config submodule.fivium-design-system-core.url https://bitbucket.org/fiviumuk/fivium-design-system-core.git
      - git submodule update --init --recursive

  - name: build-fds
    image: node:10
    commands:
      - cd fivium-design-system-core
      - npm install
      - npx gulp build
      - cd ..

  - name: build-frontend
    image: node:10
    commands:
      - npm install
      - npx gulp buildAll

  - name: build-java
    image: openjdk:11-jdk-slim
    commands:
      - chmod +x gradlew
      - ./gradlew test checkstyleMain bootWar

  - name: code-analysis
    image: aosapps/drone-sonar-plugin
    settings:
      sonar_host:
        from_secret: sonar_host
      sonar_token:
        from_secret: sonar_token
      sources: src
      exclusions: src/test/**, src/main/resources/public/assets/**, src/main/resources/templates/fds/**, fivium-design-system-core/**
    when:
      status: success
      branch: develop

  - name: publish-build-s3
    image: plugins/s3
    settings:
      bucket: fivium-oga-pipelines-resources
      region: eu-west-2
      access_key:
        from_secret: drone_oga_s3_access_key
      secret_key:
        from_secret: drone_oga_s3_secret_key
      source: build/libs/*
      target: /builds/oga
      strip_prefix: build/libs/
    when:
      status: success
      branch: [ develop, release/*, master ]

  - name: vulnerability-scan-java
    image: openjdk:11-jdk-slim
    commands:
      - chmod +x gradlew
      - ./gradlew dependencyCheckAnalyze
    volumes:
      - name: nvd-db
        path: /var/nvd-db
    when:
      branch: develop

  - name: vulnerability-scan-npm
    image: node:10.12.0
    commands:
      - npm audit > build/reports/npm-audit-report.txt || true # dont fail build if non 0 exit code
    when:
      branch: develop

  - name: sync-reports
    image: alpine
    commands:
      - mkdir -p /var/webfiles/${DRONE_BUILD_NUMBER}
      - cp -r build/reports /var/webfiles/${DRONE_BUILD_NUMBER}
    volumes:
      - name: webfiles
        path: /var/webfiles
    when:
      status: [ success, failure ]

  - name: slack
    image: plugins/slack
    settings:
      webhook: https://hooks.slack.com/services/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
      channel: oga-pipelines
      template: |
        *{{build.status}}* <{{build.link}}|Commit {{truncate build.commit 7}} on {{build.branch}} by ${DRONE_COMMIT_AUTHOR_NAME}>
        Reports published to: http://drone-assets.fivium.local:9090/pwa/{{build.number}}/
    when:
      status: [ success, failure ]

volumes:
  - name: webfiles
    host:
      path: /home/fivium/www/pwa

  - name: nvd-db
    host:
      path: /home/fivium/nvd-db